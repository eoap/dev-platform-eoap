apiVersion: skaffold/v4beta9
kind: Config
metadata:
  name: eoap-dask-gateway

deploy:
  statusCheckDeadlineSeconds: 2400
  helm:

    releases:
      - name: dask-gateway
        remoteChart: https://helm.dask.org/dask-gateway-2024.1.0.tgz
        namespace: eoap-dask-gateway
        createNamespace: true
        valuesFiles:
          - values.yaml
        setValueTemplates:
          gateway.backend.image.name: ghcr.io/eoap/dev-platform-eoap/dask-gateway-worker:0.1.0
          gateway.backend.image.tag: 2h
          gateway.backend.imagePullSecrets: 
          - name: kaniko-secret
          traefik.service.type: "ClusterIP"

      - name: eoap-dask-gateway
        chartPath: ../charts/coder
        namespace: eoap-dask-gateway
        createNamespace: true
        setValueTemplates:
          coder.coderImage: ghcr.io/eoap/dev-platform-eoap/dask-gateway-coder:0.1.0
          daskGateway.image: ghcr.io/eoap/dev-platform-eoap/dask-gateway-worker:0.1.0
        setValues:
          coder.workspace: dask-app-package
          coder.storageClassName: standard
          coder.workspaceStorage: 15Gi
          coderResources.limits.cpu: '2'
          coderResources.limits.memory: '6442450944'
          coderResources.requests.cpu: '1'
          coderResources.requests.memory: '4294967296'
          calrissian.enabled: true
          calrissian.storageClassName: standard
          skaffold.enabled: true
          daskGateway.enabled: true
          daskGateway.daskGatewayUrl: "http://traefik-dask-gateway.eoap-dask-gateway.svc.cluster.local:80"
          kaniko.enabled: true
        setFiles: {
          initScript: ./files/init.sh,
          bashrcScript: ./files/bash-rc,
          bashloginScript: ./files/bash-login
        }
      - name: eoap-dask-gateway-localstack
        remoteChart: localstack/localstack
        namespace: eoap-dask-gateway
        createNamespace: true
        setValues:
          service.type: ClusterIP
          
    hooks:
      before: []
      after:
        - host:
            command: ["sh", "-c", "./wait-for-it.sh"]
            os: [darwin, linux]
profiles:

  - name: wrs-coverage

    patches:
      - op: add
        path: /deploy/helm/releases/1/setFiles/initScript
        value: ./files/init-wrs-coverage.sh
      - op: add
        path: /deploy/helm/releases/1/setValues/coder.workspace
        value: ""

  - name: eopf-sentinel-2
  
    patches:
      - op: add
        path: /deploy/helm/releases/1/setFiles/initScript
        value: ./files/init-eopf-sentinel-2.sh
      - op: add
        path: /deploy/helm/releases/1/setValues/coder.workspace
        value: "dask-app-package/eopf-sentinel-2"

  - name: cloudless-mosaic

    patches:
      - op: add
        path: /deploy/helm/releases/1/setFiles/initScript
        value: ./files/init-cloudless-mosaic.sh
      - op: add
        path: /deploy/helm/releases/1/setValues/coder.workspace
        value: "dask-app-package/cloudless-mosaic"

portForward:
  - resourceType: service
    resourceName: code-server-service
    namespace: eoap-dask-gateway 
    address: localhost
    port: 8080
    localPort: 8000
  - resourceType: service
    resourceName: traefik-dask-gateway
    namespace: eoap-dask-gateway
    address: localhost
    port: 80
    localPort: 8001